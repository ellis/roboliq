# Todos

# Get it working for colleagues

* [x] on Charlotte's computers, `npm test` fails in `WellContents flattenContents`
* [x] make sure `npm i` works on a clean checkout in the root directory
* [ ] Protocol tutorial and Writing-a-Design: link to YAML tutorial as a pre-requisite
* [ ] autogenerate the API documentation when `npm i` is run from the root, link to API docs from the README
	* [ ] roboliq-evoware: create a README so that index.html isn't blank
	* [ ] roboliq-processor: rename "Roboliq Source" to "Roboliq Processor"
	* [ ] roboliq-processor: fix link to roboliq-evoware
	* [ ] api: figure out why index.html is basically blank
	* [ ] create top-level README with links to the other modules
* [ ] try to get `npm run processor` to work from the root directory for more complex scripts
* [ ] `npm install` instead of `npm i`
* [ ] describe in general the actions that happen by default (such as rinsing at certain times, movements that require multiple steps or opening devices)
* [ ] Writing-a-Design.md: remove `---` from the yaml files
* [ ] remove design*Test.yaml
* [ ] add repository field to root package.json
* [ ] check out why compiling from the root didn't update `npm run design`
* [ ] BUG: `npm run design` -- ignores random seed
* [ ] Document functions in design.js
* [ ] Document HACK & TRICKS: such as the "Plate" type for tube holders and Troughs, and setting "contents" property for troughs to treat as a single well
* [ ] for pipetter.pipette command, if volumes are unitless, there should be a better error message
* [ ] roboliq.yaml: add descriptions to fields on models
* [ ] api-generator: indicate whether properties are required or not
* [ ] make sure that well parser documentation is somewhere findable
* [ ] pipetter.pipette: better error message when `sources` is mispelled as `source`
* [ ] roboliq.js: validate protocol, check that initial locations are valid, e.g. no A03 on a tube holder
* [ ] check that the initial models are valid?  E.g., we told it that T1 had the 50ml tubes, but T1 can only hold 15ml tubes
* [ ] document the predicates and how the logic works

flattenArrayAndIndexes:

[{}] ; [0]

a*: 2
[{}] ; [0] =>
	[{}, {}] ; [0,1] => [{a: 1}, {a: 2}] ; [0,1]
[[{a: 1}, {a: 2}]] ; [0]
[{a: 1}, {a: 2}] ; [0,1]

b*: 2
[{a: 1}, {a: 2}] ; [0,1] =>
	[{a: 1}, {a: 1}] ; [0,1] => [{a: 1, b: 1}, {a: 1, b: 2}] ; [0,1]
	[{a: 2}, {a: 2}] ; [0,1] => [{a: 2, b: 1}, {a: 2, b: 2}] ; [0,1]
[[{a: 1, b: 1}, {a: 1, b: 2}], [{a: 2, b: 1}, {a: 2, b: 2}]] ; [0,1]
[{a: 1, b: 1}, {a: 1, b: 2}, {a: 2, b: 1}, {a: 2, b: 2}] ; [0,1,2,3]

# Things needed for Oskari's yeast script, part I on mario

* [ ] lid handling
* [ ] stacking plates via lid handling
* [ ] PCR machine
* [ ] allow for dynamic bench configuration: let user specify that P4 is a PCR site

Would be nice:

* [ ] tubes
* [ ] troughs
* [ ] print a table of labware models and sites in `bsse-mario.js`

# paper2 Todos

* [x] process 'output.units' in TecanInfinite2.js
* [ ] qc01-accuracy
	* [ ] have roboliq ask for weight measurements and save them, rather than doing all this stuff manually
	* [ ] qc01-accuracy-003
		* [?] write script
		* [ ] run script
	* [ ] qc01-accuracy-016
		* [x] write script
		* [?] run script
	* [x] qc01-accuracy-501
		* [x] write script
		* [x] run script
	* [x] write overall analysis
	* [x] run analysis
* [ ] qc02-absorbance
	* [x] qc02-absorbance-A
		* [x] write script
		* [x] write analysis
		* [x] run script
		* [x] run analysis
	* [x] qc02-absorbance-B
		* [x] write script
		* [x] write analysis
		* [x] run script
		* [x] run analysis
	* [x] qc02-absorbance-C
		* [x] write script
		* [x] write analysis
		* [x] run script
		* [x] run analysis
	* [x] write overall analysis
	* [x] run overall analysis
	* [ ] re-run overall analysis after repeating qc02-absorbance-A to correct for incorrect factor data
* [ ] qc03-dilution: unintended dilution
	* [x] write script
	* [x] write analysis
	* [x] run script
	* [x] run analysis
	* [ ] fix reader bug (missed absorbance of diluted wells A11 block E12) and re-run
* [ ] qc04-accuracy-dye
	* [x] write script
	* [.] write analysis
	* [x] run script
	* [ ] run analysis
* [x] qc05-zlevel
	* [x] write script
	* [x] write analysis
	* [x] run script
	* [x] run analysis
* [ ] script for evaporation
	* [.] write script
	* [.] write analysis
	* [ ] run script
	* [ ] run analysis
* [ ] figure out how to associate and copy R files to the '-P' directory
* [ ] trigger analysis during execution after measurements
* [ ] display analysis during execution (complication: a single Rmd file for the whole experiment often won't work, because we don't have all measurements until the end)
* [ ] save designs if the '-P' option is given (as json,md,csv?)?
* [ ] should include the 'model' in all of the designs where 'm' is part of a calculated parameter
	* or maybe it should be generated by the measurements, automatically including such data as site, model, syringe, tipModel, etc.
* [ ] handle `.rblq` files which hold command lines to execute, can generate multiple scripts?  Also include this information in the `.out.json` files

maybe use metalsmith or something simpler (handlerbars with partials, assembler) to generate the html page,
such that it can be built up incrementally as the experiment progresses.
It should also have also have an auto-reloader when the files update, or maybe better would be to trigger Atom IDE to reload it
so that we don't need an extra server running, which could get complicated when executing multiple scripts one after the other.
Steps might be:

* run R script to output CSVs, jpgs, maybe even text
* run a static site generator to create the output HTML
* trigger Atom to load/reload the HTML?

Variable substitution:

* SCOPE `$`
* DATA `$$`
* mathjs `` $`..` ``, or maybe `$(...)` would be better
* javascript `${}`
* handlebars `$|...|` for inline, `{$||: ...}` for object substitution
* javascript string substitution `` $`..` `` (if we don't use this for mathjs)
* Variables in `objects`: `$@`
* protocol parameters `$#`
* command parameters: `$^` for this command, `$^^` for the parent command, etc?
* directives: `$#` e.g. `$#length(data)` or `$#length:`

See misc.js:renderTemplateString, since another convention is used there

# Todos for Charlotte

* [ ] create Roboliq package for Atom
	* [ ] compile script using config data
	* [ ] display errors
	* [ ] display warnings
	* [ ] display designs
	* [ ] display compilation progress
	* [ ] display various infos about the final script (info that can be formatted as Markdown reasonably well)
	* [ ] possibly try to handle real-time log while the script is executing
* [4] troubleshoot protocol processing using bablified code
* [ ] use bablified code to run roboliq-runtime-cli, so it executes faster
* [ ] improve error handling/display
* [ ] at beginning of script, display notice to user about what should be on the bench, wait for user to confirm
	* [x] generate HTML file like qc02-abosrbance-B.html
	* [ ] improve HTML
		* [ ] name
		* [ ] date
		* [ ] proper table styling
		* [ ] sort order of stuff
		* [ ] proper table for well contents
		* [ ] tables for designs
		* [ ] script?
	* [x] open HTML at beginning of script
	* [x] wait for user to confirm
* [?] change from '#data' to 'data()'
* [ ] request VB code from the automated liquid class optimization people

# Documentations TODOS

* [ ] generated: separate pages for Commands and Types
* [ ] generated: sort in alphabetical order, but put low-level things later
* [ ] document the directives
* [ ] document variable substitution
* [ ] distribution documentation
	* [ ] src/roboliq/README.md
		* [ ] Getting Started
			* [ ] a protocol that doesn't require any configuration or backend
			* [ ] a protocol with a minimal configuration
			* [ ] a protocol with a backend
			* [ ] a protocol compiled for Evoware
			* [ ] running the server and getting the data during execution of an Evoware script
- [ ] user documentation (see <http://usejsdoc.org/about-tutorials.html>)
	- [x] Commands.md: Add general documentation to each command namespace
	- [ ] Commands.md: add examples for each command
	- [ ] generatedTypes: every type should completely define type, description, example
	- [ ] document the properties of the types (i.e. add 'description' field)
	- [ ] WritingADesign.md
	- [ ] Developing_Roboliq.md
	- [ ] Object_Types.md: Add general documentation to top of page
	- [ ] Using_Roboliq.md
		- [ ] add reference to WritingAProtocol.md
	- [ ] WritingAProtocol.md
	- [ ] Cookbook.md: explaining how to solve specific problems
	- [ ] Configuring a lab (e.g. `config/ourlab.js`)
	- [ ] for all commands, include documentation about required logic (e.g. transporter, equipment, pipetter)
	- [ ] convention for syringes being in 'syringe' property of pipetter
	- [ ] pipetter.cleanTips: document the various allowed parameter combinations of equipment, items, syringes, intensity
	- [ ] document the directives, such as "#createPipetteMixtureList"
- [ ] configuration documentation
	- [ ] models
	- [ ] agents
	- [ ] ...
- [ ] code documentation
	- [x] roboliq.js
	- [x] WellContents.js
	- [x] generateSchemaDocs.js
	- [x] commandHelper.js
	- [ ] figure out how to reference an anchor from a separate file (e.g. commands/centrifuge.js should reference 'centrifuge' in Commands.md)
			- continue with centrifuge.js documentaiton header (currently have experiments in there)
	- [ ] generateSchemaDocs.js: set anchors for command modules, so they can be referenced from the source code
	- [ ] generateSchemaDocs.js: why aren't descriptions generated for "Object Types" properties?
	- [ ] for parameter types, can they be links to the Type definition?
	- [ ] check generated jsdoc, and make appropriate improvements (e.g. setting modules and indicating which methods are exported)
	- [ ] generateSchemaDocs.js shouldn't be listed on the Home page of the jsdocs (probably need to remote `@file`)
	- [ ] expectCore.js
	- [ ] expect.js
	- [ ] main.js
	- [ ] misc.js
	- [ ] commands...
	- [ ] document roboliq's extensions to JSON Schema (types, 'module')
- [ ] sort through `notes`, `doc`, and `old` directories

# Bugs

* [x] qc05-zlevel: need to automatically include variables for DETECTED_VOLUME_? in the evoware script
* [ ] absorbanceReader: 'output.units' not handled in TecanInfinite2.js
* [ ] absorbanceReader: For a full plate minus F11 down H11, A11 cross E12 get skipped in the reader!
* [ ] in qc02-absorbance-B.yaml, step 4, if we don't include the extra '1' substep, `Volume {{$totalVolume}}` throws and error
* [ ] BUG: Compiling qc01-accuracy-tubes-003.yaml with dist crashes, whereas running with babel-node works
* [ ] BUG: transporter.doThenRestoreLocation: can't use `$scopeVariable` in `objects` array
* [?] BUG: transporter.doThenRestoreLocation: `equipment` wasn't used when transferring plate back to original position
* [ ] BUG: qc02-absorbance-A: in the last 'absorbanceReader.measurePlate' command, if the command isn't made into a *numbered* substep, compilation crashes when processing 'simulated'.

> ERROR:
>
>	Running this with babel-node from the roboliq-processor directory works:
>
>	`npm start -- -T --progress src/config/ourlab.js ../protocols/qc01-accuracy-tubes.yaml --print-designs -P 'C:\ProgramData\Tecan\EVOware\database\scripts\Ellis\EvowareScripts' --evoware ../testdata/bsse-mario/Carrier.cfg,../testdata/bss e-mario/NewLayout_Feb2015.ewt,ourlab.mario.evoware`
>
>	But from the root directory, this doesn't work:
>
>	`npm run processor -- -T --progress roboliq-processor/dist/config/ourlab.js protocols/qc01-accuracy-tubes.yaml --print-designs -P 'C:\ProgramData\Tecan\EVOware\database\scripts\Ellis\EvowareScripts' --evoware testdata/bsse-mario/Carrie r.cfg,testdata/bsse-mario/NewLayout_Feb2015.ewt,ourlab.mario.evoware`

# Todos

* [ ] replace usage of mustache with handlebars
* [ ] designTest: unit test for calculateRow
* [ ] Variable references:
	* SCOPE: should contain parameters, variables, data rows
	* Referencing:
		* `$`: substitute in scope variable
		* `$*`: dereference twice (consider `$$`)
		* `$$`: column array from current data table (consider `$#`)
		* `$@`: dereference variable in `objects`
		* `$&`: dereference a parameter value
		* `${${@myvar}.somevalue}`
		* `${@myvar.somevalue}`
		* "$`...`": calculation
		* template substitution with ticks
* [ ] allow for setting command defaults:
	* `commandDefaults: [{command: "transporter.*", equipment: "ourlab.mario.roma2"}]`
