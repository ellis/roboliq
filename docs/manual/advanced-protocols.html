<!DOCTYPE html>
<html >

<head>

  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Roboliq</title>
  <meta name="description" content="Roboliq">
  <meta name="generator" content="bookdown 0.4.1 and GitBook 2.6.7">

  <meta property="og:title" content="Roboliq" />
  <meta property="og:type" content="book" />
  
  
  
  <meta name="github-repo" content="ellis/roboliq" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Roboliq" />
  
  
  

<meta name="author" content="Ellis Whitehead">



  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  
  
<link rel="prev" href="simple-protocols.html">
<link rel="next" href="design-tables.html">
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />









<style type="text/css">
div.sourceCode { overflow-x: auto; }
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; } /* Keyword */
code > span.dt { color: #902000; } /* DataType */
code > span.dv { color: #40a070; } /* DecVal */
code > span.bn { color: #40a070; } /* BaseN */
code > span.fl { color: #40a070; } /* Float */
code > span.ch { color: #4070a0; } /* Char */
code > span.st { color: #4070a0; } /* String */
code > span.co { color: #60a0b0; font-style: italic; } /* Comment */
code > span.ot { color: #007020; } /* Other */
code > span.al { color: #ff0000; font-weight: bold; } /* Alert */
code > span.fu { color: #06287e; } /* Function */
code > span.er { color: #ff0000; font-weight: bold; } /* Error */
code > span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
code > span.cn { color: #880000; } /* Constant */
code > span.sc { color: #4070a0; } /* SpecialChar */
code > span.vs { color: #4070a0; } /* VerbatimString */
code > span.ss { color: #bb6688; } /* SpecialString */
code > span.im { } /* Import */
code > span.va { color: #19177c; } /* Variable */
code > span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code > span.op { color: #666666; } /* Operator */
code > span.bu { } /* BuiltIn */
code > span.ex { } /* Extension */
code > span.pp { color: #bc7a00; } /* Preprocessor */
code > span.at { color: #7d9029; } /* Attribute */
code > span.do { color: #ba2121; font-style: italic; } /* Documentation */
code > span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code > span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code > span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
</style>

</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Preface</a><ul>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#structure-of-the-manual"><i class="fa fa-check"></i>Structure of the manual</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#additional-documentation"><i class="fa fa-check"></i>Additional documentation</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#software-information-and-conventions"><i class="fa fa-check"></i>Software information and conventions</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#acknowledgements"><i class="fa fa-check"></i>Acknowledgements</a></li>
</ul></li>
<li class="chapter" data-level="1" data-path="intro.html"><a href="intro.html"><i class="fa fa-check"></i><b>1</b> Introduction</a><ul>
<li class="chapter" data-level="1.1" data-path="intro.html"><a href="intro.html#motivation"><i class="fa fa-check"></i><b>1.1</b> Motivation</a></li>
<li class="chapter" data-level="1.2" data-path="intro.html"><a href="intro.html#get-started"><i class="fa fa-check"></i><b>1.2</b> Get started</a></li>
<li class="chapter" data-level="1.3" data-path="intro.html"><a href="intro.html#usage"><i class="fa fa-check"></i><b>1.3</b> Usage</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="quick-start.html"><a href="quick-start.html"><i class="fa fa-check"></i><b>2</b> Quick Start</a><ul>
<li class="chapter" data-level="2.1" data-path="quick-start.html"><a href="quick-start.html#the-simplest-protocol"><i class="fa fa-check"></i><b>2.1</b> The simplest protocol</a></li>
<li class="chapter" data-level="2.2" data-path="quick-start.html"><a href="quick-start.html#a-protocol-with-a-minimal-configuration"><i class="fa fa-check"></i><b>2.2</b> A protocol with a minimal configuration</a></li>
<li class="chapter" data-level="2.3" data-path="quick-start.html"><a href="quick-start.html#a-bsse-protocol-for-mario"><i class="fa fa-check"></i><b>2.3</b> A BSSE protocol for mario</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="input-formats.html"><a href="input-formats.html"><i class="fa fa-check"></i><b>3</b> Input formats</a></li>
<li class="chapter" data-level="4" data-path="configuration.html"><a href="configuration.html"><i class="fa fa-check"></i><b>4</b> Robot configuration</a><ul>
<li class="chapter" data-level="4.1" data-path="configuration.html"><a href="configuration.html#evoware-configuration"><i class="fa fa-check"></i><b>4.1</b> Evoware configuration</a></li>
<li class="chapter" data-level="4.2" data-path="configuration.html"><a href="configuration.html#components"><i class="fa fa-check"></i><b>4.2</b> Components</a><ul>
<li class="chapter" data-level="4.2.1" data-path="configuration.html"><a href="configuration.html#roboliq"><i class="fa fa-check"></i><b>4.2.1</b> <code>roboliq</code></a></li>
<li class="chapter" data-level="4.2.2" data-path="configuration.html"><a href="configuration.html#schemas"><i class="fa fa-check"></i><b>4.2.2</b> <code>schemas</code></a></li>
<li class="chapter" data-level="4.2.3" data-path="configuration.html"><a href="configuration.html#objects"><i class="fa fa-check"></i><b>4.2.3</b> <code>objects</code></a></li>
<li class="chapter" data-level="4.2.4" data-path="configuration.html"><a href="configuration.html#commandhandlers"><i class="fa fa-check"></i><b>4.2.4</b> <code>commandHandlers</code></a></li>
</ul></li>
<li class="chapter" data-level="4.3" data-path="configuration.html"><a href="configuration.html#logic-components"><i class="fa fa-check"></i><b>4.3</b> Logic components</a><ul>
<li class="chapter" data-level="4.3.1" data-path="configuration.html"><a href="configuration.html#predicates"><i class="fa fa-check"></i><b>4.3.1</b> <code>predicates</code></a></li>
<li class="chapter" data-level="4.3.2" data-path="configuration.html"><a href="configuration.html#objecttopredicateconverters"><i class="fa fa-check"></i><b>4.3.2</b> <code>objectToPredicateConverters</code></a></li>
<li class="chapter" data-level="4.3.3" data-path="configuration.html"><a href="configuration.html#planhandlers"><i class="fa fa-check"></i><b>4.3.3</b> <code>planHandlers</code></a></li>
</ul></li>
<li class="chapter" data-level="4.4" data-path="configuration.html"><a href="configuration.html#conclusion"><i class="fa fa-check"></i><b>4.4</b> Conclusion</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="simple-protocols.html"><a href="simple-protocols.html"><i class="fa fa-check"></i><b>5</b> Simple Protocols</a><ul>
<li class="chapter" data-level="5.1" data-path="simple-protocols.html"><a href="simple-protocols.html#objects-1"><i class="fa fa-check"></i><b>5.1</b> Objects</a></li>
<li class="chapter" data-level="5.2" data-path="simple-protocols.html"><a href="simple-protocols.html#steps"><i class="fa fa-check"></i><b>5.2</b> Steps</a></li>
<li class="chapter" data-level="5.3" data-path="simple-protocols.html"><a href="simple-protocols.html#conclusion-1"><i class="fa fa-check"></i><b>5.3</b> Conclusion</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="advanced-protocols.html"><a href="advanced-protocols.html"><i class="fa fa-check"></i><b>6</b> Advanced Protocols</a><ul>
<li class="chapter" data-level="6.1" data-path="advanced-protocols.html"><a href="advanced-protocols.html#parameters"><i class="fa fa-check"></i><b>6.1</b> Parameters</a></li>
<li class="chapter" data-level="6.2" data-path="advanced-protocols.html"><a href="advanced-protocols.html#objects-2"><i class="fa fa-check"></i><b>6.2</b> Objects</a></li>
<li class="chapter" data-level="6.3" data-path="advanced-protocols.html"><a href="advanced-protocols.html#data"><i class="fa fa-check"></i><b>6.3</b> Data</a><ul>
<li class="chapter" data-level="6.3.1" data-path="advanced-protocols.html"><a href="advanced-protocols.html#data-type"><i class="fa fa-check"></i><b>6.3.1</b> <code>Data</code> type</a></li>
<li class="chapter" data-level="6.3.2" data-path="advanced-protocols.html"><a href="advanced-protocols.html#data-property"><i class="fa fa-check"></i><b>6.3.2</b> <code>data</code> property</a></li>
<li class="chapter" data-level="6.3.3" data-path="advanced-protocols.html"><a href="advanced-protocols.html#data.-commands"><i class="fa fa-check"></i><b>6.3.3</b> <code>data.*</code> commands</a></li>
<li class="chapter" data-level="6.3.4" data-path="advanced-protocols.html"><a href="advanced-protocols.html#data-directive"><i class="fa fa-check"></i><b>6.3.4</b> <code>data()</code> directive</a></li>
</ul></li>
<li class="chapter" data-level="6.4" data-path="advanced-protocols.html"><a href="advanced-protocols.html#scope"><i class="fa fa-check"></i><b>6.4</b> Scope</a></li>
<li class="chapter" data-level="6.5" data-path="advanced-protocols.html"><a href="advanced-protocols.html#substitution"><i class="fa fa-check"></i><b>6.5</b> Substitution</a><ul>
<li class="chapter" data-level="6.5.1" data-path="advanced-protocols.html"><a href="advanced-protocols.html#scope-substitution"><i class="fa fa-check"></i><b>6.5.1</b> Scope $ substitution</a></li>
<li class="chapter" data-level="6.5.2" data-path="advanced-protocols.html"><a href="advanced-protocols.html#template-substitution"><i class="fa fa-check"></i><b>6.5.2</b> Template ` substitution</a></li>
<li class="chapter" data-level="6.5.3" data-path="advanced-protocols.html"><a href="advanced-protocols.html#directive-substitution"><i class="fa fa-check"></i><b>6.5.3</b> Directive () substitution</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="7" data-path="design-tables.html"><a href="design-tables.html"><i class="fa fa-check"></i><b>7</b> Design Tables</a><ul>
<li class="chapter" data-level="7.1" data-path="design-tables.html"><a href="design-tables.html#first-examples"><i class="fa fa-check"></i><b>7.1</b> First examples</a></li>
<li class="chapter" data-level="7.2" data-path="design-tables.html"><a href="design-tables.html#nested-branching"><i class="fa fa-check"></i><b>7.2</b> Nested branching</a></li>
<li class="chapter" data-level="7.3" data-path="design-tables.html"><a href="design-tables.html#hidden-factors"><i class="fa fa-check"></i><b>7.3</b> Hidden factors</a></li>
<li class="chapter" data-level="7.4" data-path="design-tables.html"><a href="design-tables.html#actions"><i class="fa fa-check"></i><b>7.4</b> Actions</a><ul>
<li class="chapter" data-level="7.4.1" data-path="design-tables.html"><a href="design-tables.html#allocatewells"><i class="fa fa-check"></i><b>7.4.1</b> <code>allocateWells</code></a></li>
<li class="chapter" data-level="7.4.2" data-path="design-tables.html"><a href="design-tables.html#range"><i class="fa fa-check"></i><b>7.4.2</b> <code>range</code></a></li>
<li class="chapter" data-level="7.4.3" data-path="design-tables.html"><a href="design-tables.html#calculate"><i class="fa fa-check"></i><b>7.4.3</b> <code>calculate</code></a></li>
<li class="chapter" data-level="7.4.4" data-path="design-tables.html"><a href="design-tables.html#case"><i class="fa fa-check"></i><b>7.4.4</b> <code>case</code></a></li>
</ul></li>
<li class="chapter" data-level="7.5" data-path="design-tables.html"><a href="design-tables.html#step-and-data-nesting"><i class="fa fa-check"></i><b>7.5</b> Step and data nesting</a></li>
</ul></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Roboliq</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="advanced-protocols" class="section level1">
<h1><span class="header-section-number">6</span> Advanced Protocols</h1>
<p>Advanced protocols can contain many more elements than the simple protocols described in the previous chapter. In this chapter we’ll discuss <code>parameters</code>, <code>objects</code>, <code>data</code> properties, variable scope, substitution, directives, and template functions.</p>
<div id="parameters" class="section level2">
<h2><span class="header-section-number">6.1</span> Parameters</h2>
<p>Parameters are named values that you define at the beginning of a protocol. You can then use the parameter name instead of the value later in the protocol. In this partial example, a <code>VOLUME</code> parameter is defined which is used in the <code>pipetter.pipette</code> step:</p>
<div class="sourceCode"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span class="fu">parameters:</span>
  <span class="fu">VOLUME:</span>
    <span class="fu">description:</span> <span class="st">&quot;amount of water to dispense&quot;</span>
    <span class="fu">value:</span> 200 ul
<span class="co">...</span>
<span class="co">steps:</span>
<span class="co">  1:</span>
<span class="co">    command: pipetter.pipette</span>
<span class="co">    sources: water</span>
<span class="co">    destinations: plate1(all)</span>
<span class="co">    volumes: $#VOLUME</span></code></pre></div>
<p>A parameter should be given a <code>description</code> and a <code>value</code>. Notice that <code>$#</code> prefixes <code>VOLUME</code> in the step; <code>$#</code> tells Roboliq to substitute in a parameter value. Substitution is discussed in more detail later in this chapter.</p>
</div>
<div id="objects-2" class="section level2">
<h2><span class="header-section-number">6.2</span> Objects</h2>
<p>There are several more object types you might want to use in advanced protocols:</p>
<p><a href="../protocol/commands.html#_Data"><code>Data</code></a>: for defining a data table. The <code>Data</code> type facilitates complex experimental designs, and you can read more about it in the next section and in the chapter on <a href="design-tables.html#design-tables">Design Tables</a>.</p>
<p><a href="../protocol/commands.html#_Variable"><code>Variable</code></a>: For defining references to other variables. Variables are not particularly useful in Roboliq, but they could potentially be used to easily switch between objects in case you have, for example, two water sources <code>water1</code> and <code>water2</code>. In that case you could have a <code>water</code> variable whose value to set to the source you want to use:</p>
<div class="sourceCode"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span class="fu">objects:</span>
  <span class="fu">water1:</span> ...
  <span class="fu">water2:</span> ...
  <span class="fu">water:</span>
    <span class="fu">description:</span> <span class="st">&quot;water source&quot;</span>
    <span class="fu">type:</span> Variable
    <span class="fu">value:</span> water1
<span class="fu">steps:</span>
  <span class="fu">1:</span>
    <span class="fu">command:</span> pipetter.pipette
    <span class="fu">sources:</span> water
    <span class="fu">destinations:</span> plate1(all)
    <span class="fu">volumes:</span> 50 ul</code></pre></div>
<p><a href="../protocol/commands.html#_Template"><code>Template</code></a>: You can use a template to define re-usable steps. Here is a toy example for a template named <code>dispenseToPlate1</code> which creates a <code>pipetter.pipette</code> command that transfers a volume of water to all wells on <code>plate1</code>:</p>
<div class="sourceCode"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span class="fu">objects:</span>
  <span class="fu">plate1:</span>
    <span class="fu">type:</span> Plate
    ...
  <span class="fu">dispenseToPlate1:</span>
    <span class="fu">description:</span> <span class="st">&quot;template to dispense `volume` ul of water to all wells on plate1&quot;</span>
    <span class="fu">type:</span> Template
    <span class="fu">template:</span>
      <span class="fu">command:</span> pipetter.pipette
      <span class="fu">sources:</span> water
      <span class="fu">destinations:</span> plate1(all)
      <span class="fu">volumes:</span> <span class="st">&quot;{{volume}}&quot;</span>
<span class="fu">steps:</span>
  <span class="fu">1:</span>
    <span class="fu">command:</span> system.call
    <span class="fu">name:</span> dispenseToPlate1
    <span class="fu">params:</span>
      <span class="fu">volume:</span> 10 ul
  <span class="fu">2:</span>
    <span class="fu">command:</span> system.call
    <span class="fu">name:</span> dispenseToPlate1
    <span class="fu">params:</span>
      <span class="fu">volume:</span> 50 ul</code></pre></div>
<p>This protocol will first dispense 10ul to all wells, then another 50ul to all wells – not actually a useful protocol, but it illustrates the point. In the <code>system.call</code> command, the name of the template is specified along with the parameters template parameters. Templates are expanded using the <a href="http://handlebarsjs.com/">Handlebars</a> template engine, which is the reason for the “{{” and “}}” delimiters in the line <code>volumes: &quot;{{volume}}&quot;</code>.</p>
</div>
<div id="data" class="section level2">
<h2><span class="header-section-number">6.3</span> Data</h2>
<p>Roboliq supports data tables to enable complex experiments. Conceptually, a data table is like a spread sheet of rows and named columns, where each row represents some “thing”, a each column represents a property. In Roboliq, a data table is an array of JSON objects: each object is a row, and each property is a column. Normally all the objects will have the same set of properties (but this is not required).</p>
<p>Data tables are supported by a <code>Data</code> type, a <code>data</code> property, a <code>data()</code> directive, and a set of <code>data.*</code> commands.</p>
<div id="data-type" class="section level3">
<h3><span class="header-section-number">6.3.1</span> <code>Data</code> type</h3>
<p>You can define a data table using the <code>Data</code> object type. Here’s an example where each row has a well, a liquid source, and a volume:</p>
<div class="sourceCode"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span class="fu">objects:</span>
  <span class="fu">data1:</span>
    <span class="fu">type:</span> Data
    <span class="fu">value:</span>
      <span class="kw">-</span> <span class="kw">{</span><span class="fu">well:</span> A01<span class="kw">,</span> <span class="fu">volume:</span> 10 ul<span class="kw">,</span> <span class="fu">source:</span> liquid1<span class="kw">}</span>
      <span class="kw">-</span> <span class="kw">{</span><span class="fu">well:</span> B01<span class="kw">,</span> <span class="fu">volume:</span> 10 ul<span class="kw">,</span> <span class="fu">source:</span> liquid2<span class="kw">}</span>
      <span class="kw">-</span> <span class="kw">{</span><span class="fu">well:</span> A02<span class="kw">,</span> <span class="fu">volume:</span> 20 ul<span class="kw">,</span> <span class="fu">source:</span> liquid1<span class="kw">}</span>
      <span class="kw">-</span> <span class="kw">{</span><span class="fu">well:</span> B02<span class="kw">,</span> <span class="fu">volume:</span> 20 ul<span class="kw">,</span> <span class="fu">source:</span> liquid2<span class="kw">}</span></code></pre></div>
<p>You can define as many data tables as you want in a protocol.</p>
</div>
<div id="data-property" class="section level3">
<h3><span class="header-section-number">6.3.2</span> <code>data</code> property</h3>
<p>After defining a data table, you need to “activate” it for usage. This is done using the <code>data</code> property, which understands the following parameters:</p>
<ul>
<li><code>source</code>: this is the name of a <code>Data</code> object.</li>
<li><code>where</code>: this is an optional boolean <a href="http://mathjs.org/">mathjs</a> expression that is evaluated for each data row – only rows for which the expression evaluates to true are activated.</li>
<li><code>orderBy</code>: an optional array of column names for ordering rows. The ordering behavior is the same as the <code>_.sortBy</code> function in <a href="https://lodash.com/docs/#sortBy">lodash</a>.</li>
</ul>
<p>Any step can be given a <code>data</code> property to make a table available in that step and its sub-steps. Here’s an example application:</p>
<div class="sourceCode"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span class="fu">steps:</span>
  <span class="fu">1:</span>
    <span class="fu">data:</span> <span class="kw">{</span><span class="fu">source:</span> data1<span class="kw">}</span>
    <span class="fu">command:</span> pipetter.pipette
    <span class="fu">sources:</span> $$source
    <span class="fu">destinationPlate:</span> plate1
    <span class="fu">destinations:</span> $$well
    <span class="fu">volumes:</span> $$volume</code></pre></div>
<p>The <code>data</code> property activates our data table <code>data1</code>. The command <code>pipetter.pipette</code> can now access the data columns by using the <code>$$</code>-prefix along with the column name. So the above example is essentially equivalent to this:</p>
<div class="sourceCode"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span class="fu">steps:</span>
  <span class="fu">1:</span>
    <span class="fu">command:</span> pipetter.pipette
    <span class="fu">sources:</span> <span class="kw">[</span>liquid1<span class="kw">,</span> liquid2<span class="kw">,</span> liquid1<span class="kw">,</span> liquid2<span class="kw">]</span>
    <span class="fu">destinationPlate:</span> plate1
    <span class="fu">destinations:</span> <span class="kw">[</span>A01<span class="kw">,</span> B01<span class="kw">,</span> A02<span class="kw">,</span> B02<span class="kw">]</span>
    <span class="fu">volumes:</span> <span class="kw">[</span>10 ul<span class="kw">,</span> 10 ul<span class="kw">,</span> 20 ul<span class="kw">,</span> 20 ul<span class="kw">]</span></code></pre></div>
</div>
<div id="data.-commands" class="section level3">
<h3><span class="header-section-number">6.3.3</span> <code>data.*</code> commands</h3>
<p>Roboliq’s <code>data.*</code> commands provide two commands for more sophisticated handling of data tables: <code>data.forEachRow</code> and <code>data.forEachGroup</code>.</p>
<p><code>data.forEachRow</code> lets you run a series of steps on each row of the data table. For each row, the command activates a new data table containing only that row, and it runs its sub-<code>steps</code> using that new table. Here’s a toy example:</p>
<div class="sourceCode"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span class="fu">steps:</span>
  <span class="fu">1:</span>
    <span class="fu">data:</span> <span class="kw">{</span><span class="fu">source:</span> data1<span class="kw">}</span>
    <span class="fu">command:</span> data.forEachRow
    <span class="fu">steps:</span>
      <span class="fu">1:</span>
        <span class="fu">command:</span> pipetter.pipette
        <span class="fu">sources:</span> $source
        <span class="fu">destinationPlate:</span> plate1
        <span class="fu">destinations:</span> $well
        <span class="fu">volumes:</span> $volume
      <span class="fu">2:</span>
        <span class="fu">command:</span> fluorescenceReader.measurePlate
        <span class="fu">object:</span> plate1
        <span class="fu">output:</span>
          <span class="fu">joinKey:</span> well</code></pre></div>
<p>In this case, the sub-steps will be repeated 4 times, once for each row. That mean each well will be dispensed into and measured before moving onto the next well. Notice that here only a single $-prefix was used rather than the double $$-prefix for the column variables. When a data table is activated, Roboliq will check if any of the columns have all the same value; if so, that property and value will be automatically added to the current scope (see the next section about Scope). Scope variables are accessible via the $-prefix. Since the <code>data.forEachRow</code> command activates each row individually, all of its columns will be added to the scope.</p>
<p><code>data.forEachGroup</code> lets you operate on groups of rows at a time. You provide a <code>groupBy</code> property for it to group by, and then for each group it activates a new data table with those rows and runs its sub-<code>steps</code> using that new table. Here’s another toy example:</p>
<div class="sourceCode"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span class="fu">steps:</span>
  <span class="fu">1:</span>
    <span class="fu">data:</span> <span class="kw">{</span><span class="fu">source:</span> data1<span class="kw">}</span>
    <span class="fu">command:</span> data.forEachGroup
    <span class="fu">groupBy:</span> source
    <span class="fu">steps:</span>
      <span class="fu">1:</span>
        <span class="fu">command:</span> pipetter.pipette
        <span class="fu">sources:</span> $source
        <span class="fu">destinationPlate:</span> plate1
        <span class="fu">destinations:</span> $$well
        <span class="fu">volumes:</span> $$volume
      <span class="fu">2:</span>
        <span class="fu">command:</span> fluorescenceReader.measurePlate
        <span class="fu">object:</span> plate1
        <span class="fu">output:</span>
          <span class="fu">joinKey:</span> well</code></pre></div>
<p>Since there are two unique <code>source</code> values in <code>data1</code>, the <code>data.forEachGroup</code> command will create two new data tables for it sub-steps:</p>
<p>First table:</p>
<div class="sourceCode"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span class="kw">-</span> <span class="kw">{</span><span class="fu">well:</span> A01<span class="kw">,</span> <span class="fu">volume:</span> 10 ul<span class="kw">,</span> <span class="fu">source:</span> liquid1<span class="kw">}</span>
<span class="kw">-</span> <span class="kw">{</span><span class="fu">well:</span> A02<span class="kw">,</span> <span class="fu">volume:</span> 20 ul<span class="kw">,</span> <span class="fu">source:</span> liquid1<span class="kw">}</span></code></pre></div>
<p>Second table:</p>
<div class="sourceCode"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span class="kw">-</span> <span class="kw">{</span><span class="fu">well:</span> B01<span class="kw">,</span> <span class="fu">volume:</span> 10 ul<span class="kw">,</span> <span class="fu">source:</span> liquid2<span class="kw">}</span>
<span class="kw">-</span> <span class="kw">{</span><span class="fu">well:</span> B02<span class="kw">,</span> <span class="fu">volume:</span> 20 ul<span class="kw">,</span> <span class="fu">source:</span> liquid2<span class="kw">}</span></code></pre></div>
<p>So the sub-steps will be repeated twice, once for new data table. Notice that here we used the single $-prefix for <code>source</code>, but the double $$-prefix for <code>well</code> and <code>volume</code>. Because the values of the well and volume columns are not the same in all rows, they are not automatically added to the scape, and we can’t use the single $-prefix.</p>
</div>
<div id="data-directive" class="section level3">
<h3><span class="header-section-number">6.3.4</span> <code>data()</code> directive</h3>
<p>The <code>data()</code> directive lets you assign a modified version of your data table to a property value. It will be easier to explain this in the section on Substitution, so we’ll postpone the discussion till the end of this chapter.</p>
</div>
</div>
<div id="scope" class="section level2">
<h2><span class="header-section-number">6.4</span> Scope</h2>
<p><em>Scope</em> is the set of currently active variables in a step. These usually come from one of two sources: 1) the <code>data</code> directive and commands, as discussed above, or 2) a loop command like <code>system.repeat</code>, which lets you add an index variable to the scope of the sub-steps.</p>
<p>The scope is a kind of stacked-tower structure. When a step pushes variables into scope, they are available to that step’s command and all substeps; however, they are not available to sibling or parent steps.</p>
</div>
<div id="substitution" class="section level2">
<h2><span class="header-section-number">6.5</span> Substitution</h2>
<p><em>Substitution</em> lets you work with parameters and data tables by inserting their values into the protocol. Roboliq supports three forms: <em>template</em> substitution, <em>scope</em> substitution, and <em>directive</em> substitution.</p>
<div id="scope-substitution" class="section level3">
<h3><span class="header-section-number">6.5.1</span> Scope $ substitution</h3>
<p>In scope substition, an expression starting with $ is replaced with a value from the scope. There are various forms of replacement, which we’ll dive into now.</p>
<p><code>$#...</code>: <strong>pre-scope substitution for parameter values</strong></p>
<p>Parameters are not actually part of the scope, and they are accessible outside of steps as well. This means that they can be used in other parameter values and in object definitions, which is not the case for normal scope variables. You can substitute the value of a parameter named <code>MYPARAM</code> by with <code>$#MYPARAM</code>.</p>
<p><code>${...}</code>: <strong>javascript expression</strong></p>
<p>Roboliq will substitute in the result of a JavaScript expression. The JavaScript expression has access to:</p>
<ul>
<li>The scope variables</li>
<li><code>_</code>: the <a href="https://lodash.com/">lodash</a> module and its <a href="https://lodash.com/docs/">many functions</a>.</li>
<li><code>math</code>: the <a href="http://mathjs.org/">mathjs</a> module and its <a href="http://mathjs.org/docs/reference/functions.html">many functions</a>.</li>
</ul>
<p>Note that any value JSON value may be returned, whether it’s a string, number, boolean, array, or object.</p>
<p><code>$(...)</code>: <strong>mathjs calculation</strong></p>
<p>The <a href="http://mathjs.org/">mathjs</a> module provides a fairly broad range of math operations and is able to handle of units, such as volume. The mathjs expression has access to the current scope variables.</p>
<p><code>$...</code>: <strong>scope value substitution</strong></p>
<p>Here you just name the scope variable, and Roboliq will substitute in its value.</p>
<p>If you have activated a data table using the <code>data</code> property, then you can use <code>$colName</code> to get an array of all the values in the column named <code>colName</code>. Furthermore, if any of the data columns are filled with the same value, then that value is added to the scope as <code>$colName_ONE</code>, where <code>colName</code> is the actual name of the column. For example, if the active data table has a column named <code>plate</code> whose entries are all <code>plate1</code>, then <code>$plate1_ONE = &quot;plate1&quot;</code>.</p>
<p><strong>NOTE</strong>: Scope substitution can only be used as a parameter value, but not as a parameter name or part of a longer string. The following uses are invalid:</p>
<ul>
<li><code>text: &quot;Hello, $name&quot;</code>: Roboliq only supports scope substitution for an entire value, so the <code>name</code> value will not be substituted into this text.<br />
You can use template substitution for this purpose instead.</li>
<li><code>$myparam: 4</code>: Roboliq does not support scope substitution for property names. You can use template substitution for this purpose instead.</li>
</ul>
<p><strong>Examples</strong></p>
<p>Let’s look at examples of $-substitutions. Consider this protocol:</p>
<div class="sourceCode"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span class="fu">roboliq:</span> v1
<span class="fu">parameters:</span>
  <span class="fu">TEXT:</span> <span class="kw">{</span> <span class="fu">value:</span> <span class="st">&quot;Hello, World&quot;</span> <span class="kw">}</span>
<span class="fu">objects:</span>
  <span class="fu">data1:</span>
    <span class="fu">type:</span> Data
    <span class="fu">value:</span>
      <span class="kw">-</span> <span class="kw">{</span><span class="fu">a:</span> 1<span class="kw">,</span> <span class="fu">b:</span> 1<span class="kw">}</span>
      <span class="kw">-</span> <span class="kw">{</span><span class="fu">a:</span> 1<span class="kw">,</span> <span class="fu">b:</span> 2<span class="kw">}</span>
<span class="fu">steps:</span>
  <span class="fu">1:</span>
    <span class="fu">data:</span> data1
    <span class="fu">command:</span> system.echo
    <span class="fu">value:</span>
      <span class="fu">javascript:</span> <span class="st">&quot;${`${TEXT} ${a} ${__step.command}`}&quot;</span>
      <span class="fu">math:</span> <span class="st">&quot;$(a * 10)&quot;</span>
      <span class="fu">scopeParameter:</span> $TEXT
      <span class="fu">scopeColumn:</span> $b
      <span class="fu">scopeOne:</span> $a_ONE
      <span class="fu">scopeData:</span> $__data[0].b
      <span class="fu">scopeObjects:</span> $__objects.data1.type
      <span class="fu">scopeParameters:</span> $__parameters.TEXT.value
      <span class="fu">scopeStep:</span> $__step.command</code></pre></div>
<p>The <code>system.echo</code> command will output the object described in its <code>value</code> parameter. The resulting value is this:</p>
<div class="sourceCode"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span class="fu">javascript:</span> <span class="st">&quot;Hello, World 1 system.echo&quot;</span>
<span class="fu">math:</span> 10
<span class="fu">scopeParameter:</span> <span class="st">&quot;Hello, World&quot;</span>
<span class="fu">scopeColumn:</span> <span class="kw">[</span>1<span class="kw">,</span> 2<span class="kw">]</span>
<span class="fu">scopeOne:</span> 1
<span class="fu">scopeData:</span> 1
<span class="fu">scopeObjects:</span> <span class="st">&quot;Data&quot;</span>
<span class="fu">scopeParameters:</span> <span class="st">&quot;Hello, World&quot;</span>
<span class="fu">scopeStep:</span> <span class="st">&quot;system.echo&quot;</span></code></pre></div>
</div>
<div id="template-substitution" class="section level3">
<h3><span class="header-section-number">6.5.2</span> Template ` substitution</h3>
<p>Template substitution uses the <a href="http://handlebarsjs.com/">Handlebars</a> template engine to manipulate text. Template substitution occurs on strings that start and end with a tick (`). Here’s a simple example that produces a new string:</p>
<div class="sourceCode"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span class="fu">text:</span> <span class="st">&quot;`Hello, {{name}}`&quot;</span></code></pre></div>
<p>If the <code>name</code> in the current scope is “John”, then this will set <code>text: &quot;Hello, John&quot;</code>.</p>
<p>If the template substitution result is enclosed by braces or brackets, Roboliq will attempt to parse it as a JSON object. Here’s a trivial example that turns a template substitution into a command, assuming that <code>name</code> is currently in scope:</p>
<div class="sourceCode"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span class="fu">1:</span> `{command: &quot;system._echo&quot;, text: &quot;Hello, {{name}}&quot;}`</code></pre></div>
</div>
<div id="directive-substitution" class="section level3">
<h3><span class="header-section-number">6.5.3</span> Directive () substitution</h3>
<p>Directives are substitution functions. The main one is the <code>data()</code> directive, which was briefly mentioned above in the Data section. The other directives are also closely related to <code>Data</code> objects, and they are discussed more in the chapter on <a href="design-tables.html#design-tables">Design Tables</a>.</p>
<p>The <code>data()</code> directive lets you assign a modified version of your data table to a property value. The directive can take several properties:</p>
<ul>
<li><code>where</code>: same as for the <code>data</code> property, this lets you select a subset of rows in the active data table.</li>
<li><code>map</code>: each row in the data table will be mapped to this value. This is how you can transform your rows.</li>
<li><code>summarize</code>: like <code>map</code>, but for summarizing all the rows into a single row. Summarize has a particularity: all column names are pushed into the current scope as arrays, and they are not overwritten by a single common value even if the column only contains a single value.</li>
<li><code>join</code>: a string separator that will be used to join all elements of the array (see <code>Array#join</code> in some JavaScript documentation).</li>
<li><code>head</code>: if set to <code>true</code>,</li>
</ul>
<p>Let’s consider some examples using the <code>data1</code> table from above. Here is the table:</p>
<div class="sourceCode"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span class="kw">-</span> <span class="kw">{</span><span class="fu">well:</span> A01<span class="kw">,</span> <span class="fu">volume:</span> 10 ul<span class="kw">,</span> <span class="fu">source:</span> liquid1<span class="kw">}</span>
<span class="kw">-</span> <span class="kw">{</span><span class="fu">well:</span> B01<span class="kw">,</span> <span class="fu">volume:</span> 10 ul<span class="kw">,</span> <span class="fu">source:</span> liquid2<span class="kw">}</span>
<span class="kw">-</span> <span class="kw">{</span><span class="fu">well:</span> A02<span class="kw">,</span> <span class="fu">volume:</span> 20 ul<span class="kw">,</span> <span class="fu">source:</span> liquid1<span class="kw">}</span>
<span class="kw">-</span> <span class="kw">{</span><span class="fu">well:</span> B02<span class="kw">,</span> <span class="fu">volume:</span> 20 ul<span class="kw">,</span> <span class="fu">source:</span> liquid2<span class="kw">}</span></code></pre></div>
<p>and here are the examples:</p>
<p><strong>Directive</strong>:<br />
<code>data(): {where: 'source == &quot;liquid1&quot;'}}</code><br />
<strong>Result</strong>:</p>
<div class="sourceCode"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span class="kw">-</span> <span class="kw">{</span><span class="fu">well:</span> <span class="st">&quot;A01&quot;</span><span class="kw">, </span><span class="fu">volume:</span> <span class="st">&quot;10 ul&quot;</span><span class="kw">, </span><span class="fu">source:</span> <span class="st">&quot;liquid1&quot;</span><span class="kw">}</span>
<span class="kw">-</span> <span class="kw">{</span><span class="fu">well:</span> <span class="st">&quot;A02&quot;</span><span class="kw">, </span><span class="fu">volume:</span> <span class="st">&quot;20 ul&quot;</span><span class="kw">, </span><span class="fu">source:</span> <span class="st">&quot;liquid1&quot;</span><span class="kw">}</span></code></pre></div>
<p><strong>Directive</strong>:<br />
<code>data(): {map: '$volume'}</code><br />
<strong>Result</strong>:</p>
<div class="sourceCode"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span class="kw">[</span><span class="st">&quot;10 ul&quot;</span><span class="kw">,</span> <span class="st">&quot;10 ul&quot;</span><span class="kw">,</span> <span class="st">&quot;20 ul&quot;</span><span class="kw">,</span> <span class="st">&quot;20 ul&quot;</span><span class="kw">]</span></code></pre></div>
<p><strong>Directive</strong>:<br />
<code>data(): {where: 'source == &quot;liquid1&quot;', map: '$(volume * 2)'}</code><br />
<strong>Result</strong>:</p>
<div class="sourceCode"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span class="kw">[</span><span class="st">&quot;20 ul&quot;</span><span class="kw">,</span> <span class="st">&quot;40 ul&quot;</span><span class="kw">]</span></code></pre></div>
<p><strong>Directive</strong>:<br />
<code>data(): {map: {well: &quot;$well&quot;}}</code><br />
<strong>Result</strong>:</p>
<div class="sourceCode"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span class="kw">-</span> <span class="kw">{</span><span class="fu">well:</span> <span class="st">&quot;A01&quot;</span><span class="kw">}</span>
<span class="kw">-</span> <span class="kw">{</span><span class="fu">well:</span> <span class="st">&quot;B01&quot;</span><span class="kw">}</span>
<span class="kw">-</span> <span class="kw">{</span><span class="fu">well:</span> <span class="st">&quot;A02&quot;</span><span class="kw">}</span>
<span class="kw">-</span> <span class="kw">{</span><span class="fu">well:</span> <span class="st">&quot;B02&quot;</span><span class="kw">}</span></code></pre></div>
<p><strong>Directive</strong>:<br />
<code>data(): {map: &quot;$well&quot;, join: &quot;,&quot;}</code><br />
<strong>Result</strong>:</p>
<div class="sourceCode"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span class="st">&quot;A01,B01,A02,B02&quot;</span></code></pre></div>
<p><strong>Directive</strong>:<br />
<code>data(): {summarize: {totalVolume: '$(sum(volume))'}}</code><br />
<strong>Result</strong>:</p>
<div class="sourceCode"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span class="kw">-</span> <span class="kw">{</span><span class="fu">totalVolume:</span> <span class="st">&quot;60 ul&quot;</span><span class="kw">}</span></code></pre></div>
<p><strong>Directive</strong>:<br />
<code>data(): {groupBy: &quot;source&quot;, summarize: {source: '${source[0]}', totalVolume: '$(sum(volume))'}}</code><br />
<strong>Result</strong>:</p>
<div class="sourceCode"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span class="kw">-</span> <span class="kw">{</span><span class="fu">source:</span> <span class="st">&quot;liquid1&quot;</span><span class="kw">, </span><span class="fu">totalVolume:</span> <span class="st">&quot;30 ul&quot;</span><span class="kw">}</span>
<span class="kw">-</span> <span class="kw">{</span><span class="fu">source:</span> <span class="st">&quot;liquid2&quot;</span><span class="kw">, </span><span class="fu">totalVolume:</span> <span class="st">&quot;30 ul&quot;</span><span class="kw">}</span></code></pre></div>

</div>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="simple-protocols.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="design-tables.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": true,
"facebook": false,
"twitter": false,
"google": false,
"weibo": false,
"instapper": false,
"vk": false,
"all": ["facebook", "google", "twitter", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"download": ["roboliq.pdf"],
"toc": {
"collapse": "subsection"
}
});
});
</script>

</body>

</html>
