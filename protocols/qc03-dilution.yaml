roboliq: v1
description: |
  Find the amount of unintended dilution taking place in the fixed tips.

  * Measure empty plate
  * Fill a few control wells with 250ul water and read their absorbance.
  * for v in 3ul, 7ul, 15ul, 16ul, and 150ul:
      * each tip dispenses 250ul into a well
      * transfer v to next empty well n times (where n = 1 for 150ul, 9 for other volumes)
      * fill source and destination wells to 250ul
      * measure absorbance of source and destination wells
      * repeat the process for 3 dilutions per volume

  OrangeG 8g/L calculations to achive 250ul => ~2:

  * 50 ul / 2^5 = 1.43
  * 0.9152/ul
  * For 250ul dye to be 2: 0.9152*250 / 2 = 114x dilution (I'll use our 100x dilution)

variables:
  excitationWavelength:
    description: excitation wavelength to read absorbance
    value: 480nm

objects:
  plate1:
    type: Plate
    description: for finding meniscus parameters
    model: ourlab.model.plateModel_96_round_transparent_nunc
    location: ourlab.mario.site.P3
  tubes:
    type: Plate
    description: trough for dye
    model: ourlab.model.TROUGH
    location: ourlab.mario.site.R6
  dye:
    type: Liquid
    description: dye with concentration such that 250ul => 2
    wells: tubes(A01)
  water:
    type: Variable
    value: ourlab.mario.systemLiquid

# well,step,stage,dyeVolume,waterVolume,dilutionFactor
# A01,control,0,0,
# 1,1,A02,fill,A02,250,3,9,27,250,1
# origId,seqId,well,stage,orig,step,role,volume,count,totalTransfer,dyeVolume,dilutionFactor
# 1,1,A02,dilution,A02,1,src,3,9,27,dyeVolume0-totalTransfer,dyeVolume/250
# 1,2,A03,dilution,A02,1,dst,3,9,27,dilutionFactor0*27,dyeVolume/250
# 1,2,A03,dilution,A02,2,src,3,9,27,dyeVolume0-totalTransfer,dyeVolume/250
# 1,3,A04,dilution,A02,2,dst,3,9,27,dilutionFactor0*27,dyeVolume/250
# 1,3,A04,dilution,A02,3,src,3,9,27,dyeVolume0-totalTransfer,dyeVolume/250
# 1,4,A05,dilution,A02,3,dst,3,9,27,dilutionFactor0*27,dyeVolume/250

  design1:
    type: Design
    description: |
      * 4 control wells to be filled with water to 250ul
    conditions:
      stage: dilute
      volume*: [3 ul, 7 ul, 15 ul, 16 ul, 150 ul]
      count=calculate: '(volume == (150 ul)) ? 1 : 9'
      transferTotal=calculate: 'volume * count'
      totalVolume: 250 ul
      syringe*: 4
      origId=range: {}
      seqId*: 4
      plate=allocatePlates:
        plates: [plate1]
        groupBy: [origId]
        wellsPerPlate: 92
      # we need to add 4 control wells for each plate
      .=concat:
        groupBy: [plate]
        conditions:
          stage: control
          totalVolume: 250 ul
          seqId*: 4
      wellId=range: {}
      srcId=calculate: '(seqId == 1) ? 0 : wellId - 1'
      well=allocateWells:
        wells: "A01 right H12"
        rows: 8
        columns: 12
        groupBy: plate
      .caseA=case:
        - where: 'stage == "dilute" and seqId == 1'
          conditions:
            stage*:
              fill:
                role: dst
                seqId=calculate: "seqId - 1"
                conc: 1
              dilute:
                role: src
        - where: 'stage == "dilute" and seqId == 4'
          conditions:
            role: dst
            seqId=calculate: "seqId - 1"
        - where: 'stage == "dilute"'
          conditions:
            role*:
              dst:
                seqId=calculate: 'seqId - 1'
              src: {}
      .caseB=case:
        - where: 'stage == "dilute"'
          conditions:
            waterVolume=calculate: '(role == "src") ? transferTotal : totalVolume - transferTotal'
            .caseC=case:
              - where: 'role == "dst"'
                conditions:
                  conc=calculate: '(transferTotal/totalVolume)^seqId'
              - where: 'role == "src"'
                conditions:
                  conc=calculate: '(transferTotal/totalVolume)^(seqId - 1) * (1 - transferTotal / totalVolume)'

steps:
  data: {source: design1}
  command: experiment.forEachGroup
  groupBy: plate
  steps:
    description: "`Plate {{$plate}}`"
    1:
      description: Read absorbance of empty wells
      command: absorbanceReader.measurePlate
      object: $plate
      program:
        excitationWavelength: $@excitationWavelength
        wells:
          "#data":
            value: well
            unique: true
      output:
        appendTo: measurements
        userValues:
          totalVolume: 0
        simulated: "random(number(0.04), number(0.06))"

    2:
      data: {where: 'stage == "control"'}
      description: Handle control wells
      1:
        description: Fill control wells with water
        command: pipetter.pipette
        program: Roboliq_Water_Air_1000
        sources: water
        destinationLabware: $plate
        destinations: $$well
        volumes: $totalVolume
        clean: light
        cleanBetween: none
      2:
        description: Read absorbance of control wells
        command: absorbanceReader.measurePlate
        object: $plate
        program:
          excitationWavelength: $@excitationWavelength
        output:
          joinKey: well
          appendTo: measurements
          units:
            totalVolume: ul
          simulated: "random(number(0.02), number(0.04))"

    3:
      data: {where: 'stage == "fill"'}
      1:
        description: Dispense initial dye aliquots
        command: pipetter.pipette
        sources: dye
        destinationLabware: $plate
        destinations: $$well
        volumes: $totalVolume
        clean: flush
      2:
        description: Read absorbance of control wells
        command: absorbanceReader.measurePlate
        object: $plate
        program:
          excitationWavelength: $@excitationWavelength
        output:
          joinKey: well
          appendTo: measurements
          units:
            totalVolume: ul
          simulated: "random(number(1.9), number(2.1))"

    4:
      data: {where: 'stage == "dilute"'}
      description: "Perform dilutions"
      command: experiment.forEachGroup
      groupBy: seqId
      steps:
        description: "`Dilution step {{$seqId}}`"
        1:
          description: "Transfer dye to next well"
          command: pipetter.pipette
          sourceLabware: $plate
          sources:
            "#data":
              where: 'role == "src"'
              value: well
          destinationLabware: $plate
          destinations:
            "#data":
              where: 'role == "dst"'
              value: well
          volumes:
            "#data":
              where: 'role == "dst"'
              value: volume
          clean: flush
        2:
          description: "Fill wells to {{$totalVolume}}"
          command: pipetter.pipette
          program: Roboliq_Water_Air_1000
          sources: water
          destinationLabware: $plate
          destinations: $$well
          volumes: $$waterVolume
          clean: flush
        3:
          description: Read absorbance of control wells
          command: absorbanceReader.measurePlate
          object: $plate
          program:
            excitationWavelength: $@excitationWavelength
          output:
            joinKey: well
            appendTo: measurements
            units:
              totalVolume: ul
            simulated: "bignumber(random(number(1.9), number(2.1))) * conc"
