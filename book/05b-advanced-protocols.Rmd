# Advanced Protocols

Advanced protocols can contain many more elements than the simple protocols
described in the previous chapter.  In this chapter we'll discuss `parameters`,
`objects`, `data` properties, variable scope, substitution, directives, and template functions.

## Parameters

Parameters are named values that you define at the beginning of a protocol.
You can then use the parameter name instead of the value later in the protocol.
In this partial example, a `VOLUME` parameter is defined which is used in the
`pipetter.pipette` step:

```yaml
parameters:
  VOLUME:
    description: "amount of water to dispense"
    value: 200 ul
...
steps:
  1:
    command: pipetter.pipette
    sources: water
    destinations: plate1(all)
    volumes: $#VOLUME
```

A parameter should be given a `description` and a `value`.
Notice that `$#` prefixes `VOLUME` in the step; `$#` tells Roboliq to substitute in a parameter value.  Substitution is discussed in more detail later in this chapter.

## Objects

There are several more object types you might want to use in advanced protocols:

[`Design`](../protocol/commands.html#_Design): for defining an experimental design.
The `Design` type facilitates complex experimental designs, and you can read
more about it in the chapter on [Design Tables].

[`Variable`](../protocol/commands.html#_Variable):
For defining references to other variables.
Variables are not particularly useful in Roboliq, but they could potentially
be used to easily switch between objects in case you have, for example,
two water sources `water1` and `water2`.  In that case you could have a `water`
variable whose value to set to the source you want to use:

```yaml
objects:
  water1: ...
  water2: ...
  water:
    description: "water source"
    type: Variable
    value: water1
steps:
  1:
    command: pipetter.pipette
    sources: water
    destinations: plate1(all)
    volumes: 50 ul
```  

[`Template`](../protocol/commands.html#_Template):
You can use a template to define re-usable steps.
Here is a toy example for a template named `dispenseToPlate1` which
creates a `pipetter.pipette` command that transfers a volume of water to
all wells on `plate1`:

```yaml
objects:
  plate1:
    type: Plate
    ...
  dispenseToPlate1:
    description: "template to dispense `volume` ul of water to all wells on plate1"
    type: Template
    template:
      command: pipetter.pipette
      sources: water
      destinations: plate1(all)
      volumes: "{{volume}}"
steps:
  1:
    command: system.call
    name: dispenseToPlate1
    params:
      volume: 10 ul
  2:
    command: system.call
    name: dispenseToPlate1
    params:
      volume: 50 ul
```

This protocol will first dispense 10ul to all wells, then another 50ul to all wells -- not actually a useful protocol, but it illustrates the point.
In the `system.call` command, the name of the template is specified along with the parameters template parameters.  Templates are expanded using the [Handlebars](http://handlebarsjs.com/) template engine, which is the reason for the "{{" and "}}" delimiters in the line `volumes: "{{volume}}"`.

## Scope

*Scope* is the set of currently active variables in a step.

CONTINUE

## Substitution

*Substitution* lets you work with parameters and data tables by inserting their
values into the protocol.  Roboliq supports two forms of substitution:
*template* substitution and *scope* substitution.

### Scope \$ substitution

In scope substition, an expression starting with \$ is replaced with a value
from the scope.  There are various forms of replacement, which we'll dive into
now.

`$#...`: **pre-scope substitution for parameter values**

Parameters are not actually part of the scope, and they are accessible
outside of steps as well.  This means that they can be used in
other parameter values and in object definitions, which is not the case
for normal scope variables.  You can substitute the value of a parameter named
`MYPARAM` by with `$#MYPARAM`.  


`${...}`: **javascript expression**

Roboliq will substitute in the result of a JavaScript expression.
The JavaScript expression has access to:

  * The scope variables
  * `_`: the [lodash](https://lodash.com/) module and its [many functions](https://lodash.com/docs/).
  * `math`: the [mathjs](http://mathjs.org/) module and its [many functions](http://mathjs.org/docs/reference/functions.html).

Note that any value JSON value may be returned, whether it's a string, number,
boolean, array, or object.

`$(...)`: **mathjs calculation**

The [mathjs](http://mathjs.org/) module provides a fairly broad range of
math operations and is able to handle of units, such as volume.  The mathjs
expression has access to the current scope variables.

`$...`: **scope value substitution**

Here you just name the scope variable, and Roboliq will substitute in its
value.

`$$...`: **column array from current data table**

If you have activated a data table using the `data` property, then you can
use `$$colName` to get an array of all the values in the column named `colName`.

**NOTE**: Scope substitution can only be used as a parameter value by itself.
The following uses are invalid:

* `text: "Hello, $name"`: Roboliq only supports scope substitution for an entire
  value, so the `name` value will not be substituted into this text.  
  You can use template substitution for this purpose instead.
* `$myparam: 4`: Roboliq does not support scope substitution for property names.
  You can use template substitution for this purpose instead.

### Template \` substitution

Template substitution uses the [Handlebars](http://handlebarsjs.com/) template
engine to manipulate text.  Template substitution occurs on strings that start
and end with a tick (\`).  Here's a simple example that produces a new string:

```yaml
text: "`Hello, {{name}}`"
```

If the `name` in the current scope is "John", then this will set `text: "Hello, John"`.

If the template substitution result is enclosed by braces or brackets, Roboliq
will attempt to parse it as a JSON object.  Here's a trivial example that
turns a template substitution into a command, assuming that `name` is currently
in scope:

```yaml
1: `{command: "system._echo", text: "Hello, {{name}}"}`
```


## Functions
